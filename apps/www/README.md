# Republik Frontend

The front-end of [republik.ch](https://www.republik.ch/en).

## Usage

### Quick start

Bootstrap your .env file:

```text
cp .env.example .env
```

#### Authentication environment variables

Check the readme inside the root-folder of the mono-repo, on how to setup the env-variables for the authentication to work correctly.

#### Payment

Payment provider configuration can be passed in via the environment. `PUBLIC_BASE_URL` is used for PostFinance and PayPal return urls.

```text
PUBLIC_BASE_URL=https://example.com

STRIPE_PUBLISHABLE_KEY=pk_x

PF_PSPID=
PF_FORM_ACTION=https://e-payment.postfinance.ch/ncol/test/orderstandard.asp

PAYPAL_FORM_ACTION=https://www.sandbox.paypal.com/cgi-bin/webscr
PAYPAL_BUSINESS=
PAYPAL_DONATE_LINK=
```

#### Email

Configure at which email address you're available for general questions, investor relations and payment issues:

```text
EMAIL_CONTACT=contact@example.com
EMAIL_IR=ir@example.com
EMAIL_PAYMENT=payment@example.com
```

### Matomo

You can enable tracking by setting a base url and site id:

```text
MATOMO_URL_BASE=https://matomo.example.com
MATOMO_SITE_ID=1
```

### GraphQL code generation

When working in the Next.js app-dir located in `src/app`, the type for the queries written in `src/app/*` are automatically generated.
The generation is done based on the persisted schema files located in `./graphql/*.schema.graphql`.

| Schema file                             | Query folder                            |
| --------------------------------------- | --------------------------------------- | ------- | ----- |
| `./graphql/republik-api.schema.graphql` | `src/app/graphql/republik-api/\*_/_.(ts | graphql | gql)` |
| `./graphql/dato-cms.schema.graphql`     | `src/app/graphql/cms/\*_/_.(ts          | graphql | gql)` |

In order to update the schema files run `yarn gql:schema`, which then refetches the schema from the backend and DatoCMS and persists it in the schema files.
This has to be done manually whenever the backend schema changes.

#### Using gql-codegen

When writting a GraphQL query in a `.ts|.tsx`-file, you have to use the `gql`-function that has to be imported from the codegen folders located at `src/app/graphql/<republik-api|cms>/gql`.
When writting the queries in `.gql` or `.graphql` files, the generated query-object, that can be used inside the apollo-client operations are named as follows `<Query-Name-in-pascal-case>Document` and can be imported from `@app/graphql/<republik-api|cms>/gql/graphql`.
The generated types can also be imported from the same path. The typed Query/Mutation result follows the naming pattern `<Query-Name-in-pascal-case><Query|Mutation|Fragment>`. In addition all TS-types for all the types defined by the schema can also be imported from that same path.

Depending on the component you write, you might want it to make use of the Query types or the schema-types.
In general, reusable components should use the generic schema-types.

#### Example

<b>Query - src/app/graphl/cms/FAQQuery.graphql</b>

```graphql
query FAQ {
  faq {
    title
    introduction {
      value
    }
    entries {
      answer {
        value
      }
      question(markdown: false)
      category
    }
  }
}
```

<b>Usage in src/app/faq/page.tsx</b>

```tsx
import { FaqDocument } from '@app/graphql/cms/__generated__/gql/graphql' // <-- generated by gql-codegen

export default async function FAQPage() {
  const client = getCMSClient()
  const res = await client.query({ query: FaqDocument }) // how to use it in a server-component
  …
}
```

<b>Usage in src/app/faq/components/faq-list.tsx</b>

```tsx
import {
  FaqEntryRecord,
  FaqQuery // <-- FaqQuery is the typed query
} from '@app/graphql/cms/__generated__/gql/graphql'

type FAQListProps = {
  entries: FaqQuery['faq']['entries']
  title: FaqQuery['faq']['title']
  introduction: FaqQuery['faq']['introduction']
}

export default function FAQList({
  entries,
  title,
  introduction,
}: FAQListProps) {
  …
```

#####

### Theming

Your logo, fonts and colors? See [orbiting/styleguide](https://github.com/orbiting/styleguide#theming)

### Curtain

You can configure a curtain message, to show a teaser website.

```text
CURTAIN_MESSAGE=""
```

Additionally you can configure a backdoor URL. Opening that URL sets a cookie which allows to circumvent the countdown page.

```text
CURTAIN_BACKDOOR_URL=/iftah-ya-simsim
```

### Testing App Views

You can test how this front end looks in the app by adding following custom device to your browsers device emulator:

```text
Width: 375
Height: 667
Type: Mobile
User Agent: iPhone RepublikApp/2.0.0
```

## License

The source code is «BSD 3-clause» licensed.
